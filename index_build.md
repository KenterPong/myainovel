## 🚀 分階段執行計畫

### 階段 1：系統優化與功能完善 (優先級：中)
**目標**：效能優化、錯誤處理、用戶體驗完善、剩餘功能開發

> **💡 當前狀態**：核心功能已完成，包括故事生成、章節投票、滿意度投票、社群分享等。現在專注於系統優化和剩餘功能完善。

#### 1.1 效能優化
- [ ] 實作投票輪詢機制
- [ ] 優化資料載入策略
- [ ] 實作內容懶載入
- [ ] 優化插圖載入效能
- [ ] 實作插圖快取機制
- [ ] 優化 API 響應速度（GET 統計 API < 200ms）

#### 1.2 錯誤處理與用戶體驗
- [ ] 完善載入狀態處理
- [ ] 實作錯誤重試機制
- [ ] 添加用戶友好的錯誤提示
- [ ] 實作插圖生成失敗降級處理
- [ ] 滿意度投票動畫效果（點擊回饋）
- [ ] 社群分享按鈕 hover 效果
- [ ] 分享成功提示訊息
- [ ] 載入狀態指示器

#### 1.3 數據分析與視覺化
- [ ] 建立滿意度投票統計頁面
- [ ] 建立社群分享統計頁面
- [ ] **數據視覺化儀表板**
  - 長條圖顯示表情符號受歡迎程度
  - 熱門章節投票結果視覺化
  - 分享效果追蹤圖表
- [ ] 實作熱門章節分析
- [ ] 實作分享效果追蹤

#### 1.4 分享圖片功能完善
- [ ] 啟用分享圖片生成功能
- [ ] 修改 `IllustrationService` 支援多尺寸生成
- [ ] 建立分享圖片儲存目錄結構
- [ ] 實作圖片格式轉換和壓縮
- [ ] **圖像感知壓縮**（Perceptual Quality）優化視覺品質
- [ ] 檔案命名規範：`{chapter_id}_{platform}.webp`

#### 1.5 環境變數與配置優化
- [ ] 完善社群分享相關環境變數設定
- [ ] **動態生成 Hashtag**（品牌 + 類型 + 實際故事類型）
- [ ] 分享文案自動生成優化
- [ ] 響應式設計適配完善

#### 1.6 測試與驗收
- [ ] 功能測試
- [ ] 響應式測試
- [ ] 效能測試
- [ ] 用戶體驗測試
- [ ] 插圖生成品質測試
- [ ] 投票限制機制測試（防重複投票）

## 🔍 關鍵技術考量

### 1. 資料快取策略
- **React Query 快取** - 快取 API 資料
- **智慧型更新** - 避免不必要的 API 呼叫
- **本地狀態同步** - 確保 UI 與後端資料一致

### 2. 分頁載入機制
- **無限滾動** - 載入更多故事
- **虛擬滾動** - 處理大量投票選項
- **懶載入** - 圖片和組件按需載入

### 3. 樂觀更新策略
- **立即更新 UI** - 投票後立即顯示結果
- **後端驗證** - 確保投票有效性
- **錯誤回滾** - 投票失敗時恢復原狀態

### 4. 投票限制策略
- **IP + Session 限制** - 防止重複投票
- **時間窗口限制** - 投票有效期管理
- **頻率限制** - 防止惡意投票

### 5. 即時更新策略
- **輪詢機制** - 定期更新投票統計
- **WebSocket** - 即時推送更新（可選）
- **狀態同步** - 確保多用戶間資料一致

## 📁 檔案結構

```
src/
├── lib/
│   ├── hooks/
│   │   ├── useHomeData.ts          # 首頁資料獲取
│   │   ├── useChapterVoting.ts     # 章節投票管理
│   │   └── useVotePolling.ts       # 投票統計輪詢
│   └── services/
│       └── IllustrationService.ts  # 插圖生成服務
├── types/
│   ├── story.ts                    # 故事型別定義
│   ├── chapter.ts                  # 章節型別定義
│   ├── voting.ts                   # 投票型別定義
│   └── illustration.ts             # 插圖型別定義
├── components/
│   ├── StoryCard.tsx               # 故事卡片組件
│   ├── VotingSection.tsx           # 投票區域組件
│   ├── VoteOption.tsx              # 投票選項組件
│   ├── ContentExpander.tsx         # 內容展開組件
│   ├── OriginTags.tsx              # 故事起源標籤組件
│   ├── ChapterIllustration.tsx     # 章節插圖組件
│   ├── SatisfactionVoting.tsx      # 滿意度投票組件
│   ├── SocialSharing.tsx           # 社群分享組件
│   ├── AnalyticsDashboard.tsx     # 數據分析儀表板
│   ├── LoadingState.tsx            # 載入狀態組件
│   ├── ErrorState.tsx              # 錯誤狀態組件
│   └── EmptyState.tsx              # 空資料狀態組件
├── app/
│   └── api/
│       ├── stories/
│       │   └── [id]/
│       │       └── chapters/
│       │           ├── [chapterId]/
│       │           │   ├── vote/
│       │           │   │   └── route.ts  # 章節投票 API
│       │           │   ├── satisfaction/
│       │           │   │   └── route.ts  # 滿意度投票 API
│       │           │   └── share/
│       │           │       └── route.ts  # 社群分享 API
│       │           └── generate/
│       │               └── route.ts      # 章節生成 API（含插圖）
│       └── illustrations/
│           ├── generate/
│           │   └── route.ts              # 插圖生成 API
│           └── styles/
│               └── route.ts              # 插圖風格管理 API
├── app/
│   └── page.tsx                    # 首頁主組件
└── public/
    └── images/
        ├── stories/                # 章節插圖存放目錄
        │   └── {story_id}/         # 按故事 ID 分資料夾
        │       ├── {chapter_id}.webp  # 章節插圖檔案
        │       └── shares/         # 分享用圖片目錄
        │           ├── {chapter_id}_x.webp
        │           ├── {chapter_id}_fb.webp
        │           ├── {chapter_id}_line.webp
        │           └── {chapter_id}_threads.webp
        └── default-illustration.png  # 預設插圖
```

## 📝 驗收標準

### 階段 1 驗收標準（系統優化與功能完善）
- [ ] 投票輪詢機制正常運作
- [ ] 資料載入策略優化效果良好
- [ ] 內容懶載入功能正常
- [ ] 插圖載入效能符合預期
- [ ] 插圖快取機制運作正常
- [ ] API 響應速度優化（GET 統計 API < 200ms）
- [ ] 載入狀態處理完善
- [ ] 錯誤重試機制正常運作
- [ ] 用戶友好的錯誤提示顯示正確
- [ ] 插圖生成失敗降級處理正常
- [ ] 滿意度投票動畫效果正常
- [ ] 社群分享按鈕 hover 效果正常
- [ ] 分享成功提示訊息正常顯示
- [ ] 載入狀態指示器正常運作
- [ ] 數據視覺化儀表板正常運作
- [ ] 滿意度投票統計頁面正常
- [ ] 社群分享統計頁面正常
- [ ] 熱門章節分析功能正常
- [ ] 分享效果追蹤功能正常
- [ ] 分享圖片生成功能正常
- [ ] 多尺寸圖片生成正常
- [ ] 圖像感知壓縮效果良好
- [ ] 動態 Hashtag 生成正常
- [ ] 分享文案自動生成優化
- [ ] 響應式設計適配正常
- [ ] 投票限制機制正常運作（防重複投票）
- [ ] 功能測試通過
- [ ] 響應式測試通過
- [ ] 效能測試通過
- [ ] 用戶體驗測試通過
- [ ] 插圖生成品質測試通過

### 整體驗收標準
- [ ] 資料庫擴展完成，包含章節投票相關表、插圖欄位、滿意度投票和分享記錄表
- [ ] API 端點正常運作，支援投票、統計查詢、滿意度投票和社群分享
- [ ] 首頁能正確顯示真實的故事資料
- [ ] 章節投票功能正常運作
- [ ] 投票達到門檻時能觸發 AI 生成
- [ ] 章節插圖生成功能正常運作
- [ ] 插圖風格一致性管理正常
- [ ] 滿意度投票系統正常運作
- [ ] 社群分享系統正常運作
- [ ] 分享文案和圖片優化功能正常
- [ ] 載入狀態和錯誤處理完善
- [ ] 響應式設計正常
- [ ] 效能符合預期
- [ ] 程式碼品質良好，有適當的註解

## 🔄 與現有系統整合

### 已完成的核心功能
- ✅ **故事起源投票系統**：`origin_votes` 和 `origin_vote_totals` 表
- ✅ **章節投票系統**：`chapter_votes` 和 `chapter_vote_totals` 表
- ✅ **AI 生成系統**：故事生成、章節生成、插圖生成
- ✅ **章節插圖生成系統**：OpenAI DALL-E 3 整合、風格一致性管理
- ✅ **滿意度投票系統**：`chapter_satisfaction_votes` 表、4種表情符號投票
- ✅ **社群分享系統**：`chapter_shares` 表、多平台分享（X、Facebook、Line、Threads）
- ✅ **章節標題優化**：移除「第x章：」前綴，AI生成純章節標題
- ✅ **插圖生成優化**：確保原本插圖先生成完成，避免分享圖片生成影響核心功能

### 待完善的功能
- 🔄 **效能優化**：投票輪詢、資料載入策略、內容懶載入
- 🔄 **錯誤處理**：載入狀態、錯誤重試、用戶友好提示
- 🔄 **數據分析**：統計頁面、視覺化儀表板、效果追蹤
- 🔄 **分享圖片**：多尺寸生成、圖像感知壓縮、格式轉換
- 🔄 **用戶體驗**：動畫效果、hover效果、成功提示
- 🔄 **測試驗收**：功能測試、響應式測試、效能測試