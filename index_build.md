## 🚀 分階段執行計畫

### 階段 0：導航系統優化 (優先級：高)
**目標**：精簡導航選項，移除會員依賴功能，優化手機和電腦版導航體驗

#### 0.1 手機底部導航欄優化
- [ ] 精簡為 5 個核心功能：首頁、起源、暫存、免責聲明、語系底部彈出選單
- [ ] 移除通知功能（無會員機制）
- [ ] 調整圖示設計：
  - 首頁：🏠 (Home) - 保持現有
  - 起源：✨ (Sparkle) - 從勾選改為閃耀圖示，更具 AI 創作科技感
  - 暫存：🔖 (Bookmark) - 保持現有收藏圖示
  - 免責聲明：⚖️ (Balance) - 新增天秤圖示
  - 語系選單：🌐 (Globe) - 新增地球圖示，點擊彈出選單
- [ ] 實現語系選單彈窗功能：點擊後在底部彈出語言選項，不跳轉頁面
- [ ] 優化高亮狀態：當前頁面使用品牌色高亮，其他使用灰色線框

#### 0.2 電腦版側邊欄優化
- [ ] 保持現有 5 個主要選項：首頁、起源、暫存、免責聲明、語系下拉選單
- [ ] 移除通知功能（無會員機制）
- [ ] 調整圖示設計與手機版保持一致
- [ ] 保留語系下拉選單在側邊欄底部
- [ ] 簡化設定子選單，將免責聲明提升為主要選項

#### 0.3 語系選單實作策略
- [ ] **電腦版**：保持側邊欄底部的下拉選單
- [ ] **手機版**：底部導航右邊增加語系彈窗選項
- [ ] 支援語言：繁體中文、簡體中文、English、日本語、한국어、泰文
- [ ] 實現語言切換功能
- [ ] 優化彈窗互動體驗

### 階段 1：首頁UI重構 (優先級：高)
**目標**：實現新的首頁UI設計，移除不需要的元素，調整版面配置

#### 1.1 移除頁面標題區塊
- [ ] 移除「最新章節」和「跟隨故事的最新發展」文字
- [ ] 調整首頁標題區塊為空白或簡化

#### 1.2 重構StoryCard組件
- [ ] 調整章節標題顯示格式：`[故事標題] 第X章: 章節標題`
- [ ] 將「投票中」標籤移到章節文字右邊
- [ ] 移除重複的故事標題和建立日期區塊
- [ ] 在章節標題下方添加故事起源標籤顯示

#### 1.3 實現文章預覽功能
- [ ] 限制章節內容顯示為擷取到前200字內的段落或斷行符號為止
- [ ] 添加「點擊展開完整內容」功能
- [ ] 處理滑動手勢衝突（文章區域禁用滑動）
- [ ] **確保AI生成完整章節內容**：每章節至少800字，生成內容前要先讀取JSON在做生成，內容要豐富且不重複
- [ ] **驗證AI生成品質**：檢查生成內容是否為真實故事內容，非模板文字
- [ ] **移除自動更新功能**：移除首頁和投票的自動輪詢更新，避免妨礙使用者閱讀和投票

#### 1.4 簡化投票區塊
- [ ] 移除「章節投票」標題
- [ ] 用一行簡短文字說明投票狀態
- [ ] 移除故事起源投票區塊

#### 1.5 實現章節排序與導航
- [ ] 實現**跨故事**章節按生成時間由新到舊排序顯示
- [ ] 新章節自動置頂功能（不區分故事）
- [ ] 非第一章節時顯示左右箭頭導航
- [ ] 實現章節跳轉功能

#### 1.6 實現故事篩選功能
- [ ] 點擊故事標題篩選該故事所有章節
- [ ] 篩選後的章節按新到舊排序
- [ ] 提供返回全部章節的選項

#### 1.7 實現章節投票UI改進
- [ ] 投票項目收合功能：預設收合狀態，點擊展開投票選項
- [ ] 導航按鈕圖標化：移除文字，使用圖標按鈕
- [ ] 三按鈕導航佈局：上一章、章節列表、下一章
- [ ] 動態圖標切換：根據視圖狀態切換中間按鈕圖標
- [ ] 章節列表展開功能：顯示該故事所有章節並支援跳轉

### 階段 2：故事起源標籤整合 (優先級：中)
**目標**：從資料庫獲取並顯示故事起源的三個類型標籤

#### 2.1 擴展資料獲取
- [ ] 修改 `useHomeData` Hook 獲取故事起源投票資料
- [ ] 建立標籤映射函數（ID → 中文標籤）
- [ ] 處理未投票狀態的顯示

#### 2.2 標籤顯示組件
- [ ] 建立 `OriginTags` 組件
- [ ] 實現三圈標籤的視覺設計
- [ ] 處理標籤的響應式顯示

### 階段 3：內容展開機制 (優先級：中)
**目標**：實現流暢的文章內容展開體驗

#### 3.1 展開組件開發
- [ ] 建立 `ContentExpander` 組件
- [ ] 實現 Modal 或 Accordion 展開方式
- [ ] 處理長內容的載入優化

#### 3.2 手勢衝突處理
- [ ] 區分點擊和滑動手勢
- [ ] 在文章內容區域禁用滑動
- [ ] 保持頁籤切換功能正常

### 階段 4：章節投票系統完善 (優先級：低)
**目標**：完善章節投票功能，實現即時統計和AI觸發

#### 4.1 資料庫擴展
- [ ] 建立 `chapter_votes` 表
- [ ] 建立 `chapter_vote_totals` 表
- [ ] 建立相關索引和觸發器

#### 4.2 API 開發
- [ ] 建立章節投票 API 端點
- [ ] 建立投票統計 API 端點
- [ ] 實作投票限制和驗證

#### 4.3 前端整合
- [ ] 建立投票相關 Hooks
- [ ] 建立投票組件
- [ ] 整合到故事卡片中

### 階段 5：章節插圖生成系統 (優先級：中)
**目標**：整合 AI 插圖生成功能，為每個章節自動生成高品質插圖

#### 5.1 資料庫擴展
- [ ] 在 `chapters` 表新增插圖相關欄位：
  - `illustration_url` (TEXT) - 本地儲存的圖片連結
  - `illustration_prompt` (TEXT) - 插圖生成提示詞
  - `illustration_style` (VARCHAR(100)) - 插圖風格
  - `illustration_generated_at` (TIMESTAMP) - 插圖生成時間
- [ ] 在 `story_settings` 表新增 `插圖風格` 設定類型
- [ ] 建立插圖風格設定的 JSONB 資料結構
- [ ] 建立資料庫遷移腳本

#### 5.2 環境變數設定
- [ ] 新增 AI 插圖生成相關環境變數：
  - `OPENAI_IMAGE_MODEL=dall-e-3`
  - `OPENAI_IMAGE_QUALITY=standard`
  - `OPENAI_IMAGE_SIZE=1024x1024`
  - `IMAGE_OUTPUT_FORMAT=webp`
  - `IMAGE_QUALITY=85`
  - `IMAGE_STORAGE_PATH=public/images/stories`

#### 5.3 圖片處理服務開發
- [ ] 建立 `IllustrationService` 類別
- [ ] 實作 OpenAI DALL-E 3 API 呼叫功能
- [ ] 實作圖片下載和格式轉換功能
- [ ] 整合 Sharp 圖片處理庫
- [ ] 實作 WebP 格式轉換和優化
- [ ] 實作本地檔案儲存機制

#### 5.4 插圖生成流程整合
- [ ] 修改章節生成 API (`/api/stories/[id]/chapters/generate`)
- [ ] 在章節內容生成後自動觸發插圖生成
- [ ] 實作異步插圖生成機制
- [ ] 整合插圖生成到章節儲存流程
- [ ] 實作插圖生成錯誤處理和重試機制

#### 5.5 故事風格管理系統
- [ ] 建立故事類型與插圖風格對應表
- [ ] 實作風格提示詞模板系統
- [ ] 建立風格一致性驗證機制
- [ ] 實作故事風格設定 API
- [ ] 建立風格預覽功能

#### 5.6 插圖顯示功能
- [ ] 修改 `StoryCard` 組件支援插圖顯示
- [ ] 實作插圖懶載入機制
- [ ] 整合 Next.js Image 組件優化
- [ ] 實作插圖載入狀態和錯誤處理
- [ ] 建立預設插圖備用機制

#### 5.7 檔案管理系統
- [ ] 建立 `public/images/stories/` 目錄結構
- [ ] 實作按故事 ID 分資料夾存放機制
- [ ] 建立檔案命名規範 (`{chapter_id}.webp`)
- [ ] 實作檔案清理和維護功能
- [ ] 建立插圖檔案完整性檢查

### 階段 6：導航系統整合測試 (優先級：中)
**目標**：測試導航系統優化效果，確保手機和電腦版導航功能正常

#### 6.1 導航功能測試
- [ ] 手機底部導航欄 5 個核心功能測試
- [ ] 電腦版側邊欄功能測試
- [ ] 語系選單彈窗功能測試
- [ ] 圖示顯示和互動效果測試
- [ ] 響應式設計適配測試

#### 6.2 用戶體驗驗收
- [ ] 導航流程順暢性測試
- [ ] 語系切換功能測試
- [ ] 免責聲明頁面跳轉測試
- [ ] 收藏功能整合測試
- [ ] 跨裝置一致性測試

### 階段 7：優化與測試 (優先級：低)
**目標**：效能優化、錯誤處理、用戶體驗完善

#### 7.1 效能優化
- [ ] 實作投票輪詢機制
- [ ] 優化資料載入策略
- [ ] 實作內容懶載入
- [ ] 優化插圖載入效能
- [ ] 實作插圖快取機制

#### 7.2 錯誤處理
- [ ] 完善載入狀態處理
- [ ] 實作錯誤重試機制
- [ ] 添加用戶友好的錯誤提示
- [ ] 實作插圖生成失敗降級處理

#### 7.3 測試與驗收
- [ ] 功能測試
- [ ] 響應式測試
- [ ] 效能測試
- [ ] 用戶體驗測試
- [ ] 插圖生成品質測試

### 階段 8：章節滿意度投票與社群分享系統 (優先級：中)
**目標**：增加讀者互動參與度，提升社群擴散效果

#### 8.1 資料庫擴展
- [ ] 建立 `chapter_satisfaction_votes` 表
  - `vote_id` (SERIAL PRIMARY KEY)
  - `chapter_id` (INTEGER REFERENCES chapters)
  - `vote_type` (VARCHAR(20)) - 'like', 'star', 'fire', 'heart'
  - `ip_address` (INET) - 防重複投票
  - `user_agent` (TEXT) - 瀏覽器資訊
  - `created_at` (TIMESTAMP) - 投票時間
- [ ] 建立 `chapter_shares` 表
  - `share_id` (SERIAL PRIMARY KEY)
  - `chapter_id` (INTEGER REFERENCES chapters)
  - `platform` (VARCHAR(20)) - 'twitter', 'facebook', 'line', 'instagram'
  - `ip_address` (INET) - 統計分析
  - `created_at` (TIMESTAMP) - 分享時間
- [ ] 建立相關索引優化查詢效能

#### 8.2 滿意度投票功能開發
- [ ] 建立滿意度投票 API 端點
  - `POST /api/stories/[id]/chapters/[chapterId]/satisfaction` - 提交投票
  - `GET /api/stories/[id]/chapters/[chapterId]/satisfaction` - 獲取統計
- [ ] 實作投票限制機制（IP 防重複投票）
- [ ] 建立滿意度投票組件
  - 2x2 網格排列的表情符號按鈕
  - 即時顯示總票數
  - 投票後視覺回饋
- [ ] 整合到章節卡片中

#### 8.3 社群分享功能開發
- [ ] 建立社群分享 API 端點
  - `POST /api/stories/[id]/chapters/[chapterId]/share` - 記錄分享
  - `GET /api/stories/[id]/chapters/[chapterId]/share-stats` - 獲取分享統計
- [ ] 實作分享文案自動生成
  - 根據平台調整字元限制（Twitter 60字元，其他 80-100字元）
  - 動態生成 Hashtag（品牌 + 類型 + 故事類型）
  - 包含章節摘要和表情符號
- [ ] 實作圖片分享優化
  - 預生成各平台專用尺寸圖片
  - WebP 格式優化
  - 檔案命名規範：`{chapter_id}_{platform}.webp`
- [ ] 建立社群分享組件
  - 支援 4 個平台按鈕（X、Facebook、Line、Instagram）
  - 一鍵分享功能
  - 分享統計顯示

#### 8.4 環境變數設定
- [ ] 新增社群分享相關環境變數：
  - `SOCIAL_SHARE_ENABLED=true`
  - `SOCIAL_SHARE_PLATFORMS=twitter,facebook,line,instagram`
  - `SOCIAL_HASHTAG_MAIN=#AIStepMasterS1`
  - `SOCIAL_HASHTAG_TYPE=#AI小說`
  - `SOCIAL_SHARE_MAX_LENGTH=100`
  - `SOCIAL_SHARE_INCLUDE_EXCERPT=true`
  - `SOCIAL_IMAGE_GENERATE_SIZES=true`
  - `SOCIAL_IMAGE_QUALITY=85`
  - `SOCIAL_IMAGE_FORMAT=webp`

#### 8.5 圖片分享優化整合
- [ ] 修改 `IllustrationService` 支援多尺寸生成
- [ ] 在章節插圖生成時同時生成分享用圖片
- [ ] 建立分享圖片儲存目錄結構
- [ ] 實作圖片格式轉換和壓縮

#### 8.6 用戶體驗優化
- [ ] 滿意度投票動畫效果（點擊回饋）
- [ ] 社群分享按鈕 hover 效果
- [ ] 分享成功提示訊息
- [ ] 響應式設計適配
- [ ] 載入狀態指示器

#### 8.7 統計分析功能
- [ ] 建立滿意度投票統計頁面
- [ ] 建立社群分享統計頁面
- [ ] 實作熱門章節分析
- [ ] 實作分享效果追蹤

## 🔍 關鍵技術考量

### 1. 資料快取策略
- **React Query 快取** - 快取 API 資料
- **智慧型更新** - 避免不必要的 API 呼叫
- **本地狀態同步** - 確保 UI 與後端資料一致

### 2. 分頁載入機制
- **無限滾動** - 載入更多故事
- **虛擬滾動** - 處理大量投票選項
- **懶載入** - 圖片和組件按需載入

### 3. 樂觀更新策略
- **立即更新 UI** - 投票後立即顯示結果
- **後端驗證** - 確保投票有效性
- **錯誤回滾** - 投票失敗時恢復原狀態

### 4. 投票限制策略
- **IP + Session 限制** - 防止重複投票
- **時間窗口限制** - 投票有效期管理
- **頻率限制** - 防止惡意投票

### 5. 即時更新策略
- **輪詢機制** - 定期更新投票統計
- **WebSocket** - 即時推送更新（可選）
- **狀態同步** - 確保多用戶間資料一致

## 📁 檔案結構

```
src/
├── lib/
│   ├── hooks/
│   │   ├── useHomeData.ts          # 首頁資料獲取
│   │   ├── useChapterVoting.ts     # 章節投票管理
│   │   └── useVotePolling.ts       # 投票統計輪詢
│   └── services/
│       └── IllustrationService.ts  # 插圖生成服務
├── types/
│   ├── story.ts                    # 故事型別定義
│   ├── chapter.ts                  # 章節型別定義
│   ├── voting.ts                   # 投票型別定義
│   └── illustration.ts             # 插圖型別定義
├── components/
│   ├── StoryCard.tsx               # 故事卡片組件
│   ├── VotingSection.tsx           # 投票區域組件
│   ├── VoteOption.tsx              # 投票選項組件
│   ├── ContentExpander.tsx         # 內容展開組件
│   ├── OriginTags.tsx              # 故事起源標籤組件
│   ├── ChapterIllustration.tsx     # 章節插圖組件
│   ├── SatisfactionVoting.tsx      # 滿意度投票組件
│   ├── SocialSharing.tsx           # 社群分享組件
│   ├── LoadingState.tsx            # 載入狀態組件
│   ├── ErrorState.tsx              # 錯誤狀態組件
│   └── EmptyState.tsx              # 空資料狀態組件
├── app/
│   └── api/
│       ├── stories/
│       │   └── [id]/
│       │       └── chapters/
│       │           ├── [chapterId]/
│       │           │   ├── vote/
│       │           │   │   └── route.ts  # 章節投票 API
│       │           │   ├── satisfaction/
│       │           │   │   └── route.ts  # 滿意度投票 API
│       │           │   └── share/
│       │           │       └── route.ts  # 社群分享 API
│       │           └── generate/
│       │               └── route.ts      # 章節生成 API（含插圖）
│       └── illustrations/
│           ├── generate/
│           │   └── route.ts              # 插圖生成 API
│           └── styles/
│               └── route.ts              # 插圖風格管理 API
├── app/
│   └── page.tsx                    # 首頁主組件
└── public/
    └── images/
        ├── stories/                # 章節插圖存放目錄
        │   └── {story_id}/         # 按故事 ID 分資料夾
        │       ├── {chapter_id}.webp  # 章節插圖檔案
        │       └── shares/         # 分享用圖片目錄
        │           ├── {chapter_id}_twitter.webp
        │           ├── {chapter_id}_facebook.webp
        │           ├── {chapter_id}_line.webp
        │           └── {chapter_id}_instagram.webp
        └── default-illustration.png  # 預設插圖
```

## 📝 驗收標準

### 階段 0 驗收標準（導航系統優化）
- [ ] 手機底部導航欄精簡為 5 個核心功能
- [ ] 圖示設計符合規範：首頁🏠、起源✨、暫存🔖、免責聲明⚖️、語系選單🌐
- [ ] 語系選單彈窗功能正常運作（手機版）
- [ ] 電腦版側邊欄語系下拉選單保留
- [ ] 移除通知功能（無會員機制）
- [ ] 高亮狀態顯示正確
- [ ] 響應式設計適配良好

### 階段 1 驗收標準
- [ ] 首頁不顯示「最新章節」等標題文字
- [ ] 章節標題格式為「[故事標題] 第X章: 章節標題」
- [ ] 「投票中」標籤位於章節文字右邊
- [ ] 移除重複的故事標題和建立日期區塊
- [ ] 章節內容限制為前200字預覽
- [ ] 點擊文章可展開完整內容
- [ ] 滑動手勢不影響文章展開功能
- [ ] 投票區塊簡化為一行說明文字
- [ ] 移除故事起源投票區塊
- [ ] 投票項目預設收合，點擊可展開
- [ ] 導航按鈕使用圖標，無文字顯示
- [ ] 三按鈕導航佈局正常運作
- [ ] 章節列表展開功能正常
- [ ] 動態圖標切換功能正常
- [ ] **AI生成章節內容品質驗證**：每章節至少800字，內容豐富且不重複
- [ ] **章節內容真實性檢查**：確保為AI生成的真實故事內容，非模板文字
- [ ] **移除自動更新功能**：移除首頁和投票的自動輪詢更新，避免妨礙使用者閱讀和投票

### 階段 2 驗收標準
- [ ] 章節標題下方顯示故事起源標籤
- [ ] 標籤顯示為中文名稱而非ID
- [ ] 未投票狀態有適當的顯示處理
- [ ] 標籤在手機版和桌面版都有良好顯示

### 階段 3 驗收標準
- [ ] 文章內容可流暢展開和收合
- [ ] 展開方式不影響頁面其他功能
- [ ] 長內容載入效能良好
- [ ] 手勢操作直觀且無衝突

### 階段 5 驗收標準（章節插圖生成系統）
- [ ] 資料庫成功新增插圖相關欄位
- [ ] 環境變數設定正確，包含所有插圖生成參數
- [ ] IllustrationService 類別正常運作
- [ ] OpenAI DALL-E 3 API 整合成功
- [ ] 圖片下載和 WebP 轉換功能正常
- [ ] 本地檔案儲存機制運作正常
- [ ] 章節生成後能自動觸發插圖生成
- [ ] 故事風格管理系統運作正常
- [ ] 插圖在首頁正確顯示
- [ ] 插圖懶載入和優化功能正常
- [ ] 預設插圖備用機制運作正常
- [ ] 檔案管理系統正常運作

### 階段 8 驗收標準（章節滿意度投票與社群分享系統）
- [ ] 資料庫成功新增滿意度投票和分享記錄表
- [ ] 滿意度投票 API 正常運作，支援 4 種表情符號投票
- [ ] 社群分享 API 正常運作，支援 4 個平台分享
- [ ] 滿意度投票組件正常顯示和互動
- [ ] 社群分享組件正常顯示和互動
- [ ] 分享文案自動生成功能正常
- [ ] 圖片分享優化功能正常（多尺寸預生成）
- [ ] 環境變數設定正確，包含所有分享相關參數
- [ ] 投票限制機制正常運作（防重複投票）
- [ ] 分享統計功能正常運作
- [ ] 響應式設計適配正常
- [ ] 用戶體驗優化效果良好

### 整體驗收標準
- [ ] 資料庫擴展完成，包含章節投票相關表、插圖欄位、滿意度投票和分享記錄表
- [ ] API 端點正常運作，支援投票、統計查詢、滿意度投票和社群分享
- [ ] 首頁能正確顯示真實的故事資料
- [ ] 章節投票功能正常運作
- [ ] 投票達到門檻時能觸發 AI 生成
- [ ] 章節插圖生成功能正常運作
- [ ] 插圖風格一致性管理正常
- [ ] 滿意度投票系統正常運作
- [ ] 社群分享系統正常運作
- [ ] 分享文案和圖片優化功能正常
- [ ] 載入狀態和錯誤處理完善
- [ ] 響應式設計正常
- [ ] 效能符合預期
- [ ] 程式碼品質良好，有適當的註解

## 🔄 與現有系統整合

### 故事起源投票系統
- 保持現有的 `origin_votes` 和 `origin_vote_totals` 表
- 維持現有的投票限制和驗證機制
- 整合到首頁的故事展示中

### 章節投票系統
- 新增 `chapter_votes` 和 `chapter_vote_totals` 表
- 實作章節投票 API
- 整合到故事卡片中

### AI 生成系統
- 保持現有的故事生成流程
- 新增章節投票觸發機制
- 整合投票結果到 AI 生成參數中
- 新增章節插圖生成功能
- 整合插圖生成到章節生成流程

### 章節插圖生成系統
- 整合 OpenAI DALL-E 3 API
- 實作故事風格一致性管理
- 建立本地圖片儲存機制
- 整合到現有章節生成流程
- 支援 WebP 格式優化
- 建立插圖顯示和載入優化機制

### 章節滿意度投票與社群分享系統
- 整合滿意度投票功能到章節卡片
- 實作社群媒體分享功能
- 建立分享文案自動生成機制
- 整合圖片分享優化功能
- 建立投票和分享統計分析
- 支援多平台分享（X、Facebook、Line、Instagram）
