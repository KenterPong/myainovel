# 故事起源 AI 整合功能

## 功能概述

當故事起源頁面的三個類型（故事類型、故事背景、故事主題）都達到 100 票門檻時，系統會自動觸發 AI 故事生成功能，並將生成的完整故事設定儲存到資料庫中。

## 技術實作

### 1. API 端點
- **路徑**: `/api/stories/generate`
- **方法**: POST
- **功能**: 接收投票結果，呼叫 OpenAI API 生成故事設定，並儲存到資料庫

### 2. 資料庫整合
- **stories 表**: 儲存故事基本資訊
- **story_settings 表**: 儲存詳細的故事設定（角色、世界觀、大綱）

### 3. 前端整合
- 投票達到門檻時自動觸發 AI 生成
- 顯示生成進度載入畫面
- 展示完整的故事設定結果

## 使用流程

### 1. 投票階段
1. 使用者在故事起源頁面選擇三個類型的選項
2. 系統即時更新票數
3. 當任一類型的選項達到 100 票時，該選項會標示為「已達成」

### 2. AI 生成階段
1. 當三個類型都有選項達到 100 票時，自動觸發 AI 生成
2. 系統顯示「AI 正在創作故事...」載入畫面
3. 呼叫 OpenAI GPT-4o-mini 模型生成完整故事設定

### 3. 結果展示階段
1. 生成完成後顯示完整的故事設定
2. 包含：標題、類型、世界觀、角色、衝突、主題、環境、大綱
3. 提供「重新開始」和「查看故事詳情」按鈕

## 環境設定

### 必要環境變數
```env
# OpenAI API 金鑰
OPENAI_API_KEY=your-openai-api-key

# 資料庫連線
DATABASE_URL=postgresql://username:password@localhost:5432/myainovel
```

### 資料庫初始化
```bash
# 初始化資料庫
npm run db:init

# 測試資料庫連線
npm run db:test
```

## 測試

### 手動測試
1. 啟動開發伺服器：`npm run dev`
2. 訪問故事起源頁面：`http://localhost:3000/origin`
3. 進行投票直到三個類型都達到 100 票
4. 觀察 AI 生成流程

### 自動化測試
```bash
# 執行測試腳本
node scripts/test-story-generation.js
```

## 資料結構

### AI 生成的故事設定格式
```json
{
  "title": "故事標題",
  "genre": "故事類型",
  "worldview": "背景世界觀描述",
  "characters": [
    {
      "name": "角色名稱",
      "age": "年齡",
      "role": "角色定位",
      "personality": "性格特點",
      "background": "背景故事"
    }
  ],
  "conflict": "核心衝突描述",
  "theme": "故事主題",
  "setting": "故事背景環境",
  "outline": {
    "beginning": "開頭設定",
    "development": "發展過程",
    "climax": "高潮情節",
    "ending": "結局安排"
  }
}
```

### 資料庫儲存結構
- **stories 表**: 儲存 `title`、`status`、`created_at` 等基本資訊
- **story_settings 表**: 分別儲存角色、世界觀、大綱三種設定類型

## 錯誤處理

### API 錯誤
- OpenAI API 連線失敗
- JSON 解析錯誤
- 資料庫儲存失敗

### 前端錯誤
- 網路連線問題
- 生成超時
- 資料格式錯誤

## 效能考量

### OpenAI API
- 使用 GPT-4o-mini 模型平衡成本與品質
- 設定 60 秒超時限制
- 溫度設定為 0.8 平衡創意與一致性

### 資料庫
- 使用事務確保資料一致性
- JSONB 欄位儲存複雜結構化資料
- 適當的索引提升查詢效能

## 未來擴展

### 功能增強
- 支援更多故事類型選項
- 自訂投票門檻設定
- 故事生成進度追蹤
- 多語言支援

### 技術優化
- 快取機制減少 API 呼叫
- 非同步處理提升使用者體驗
- 錯誤重試機制
- 效能監控與分析
