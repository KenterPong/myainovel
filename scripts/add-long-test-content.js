/**
 * æ·»åŠ é•·æ¸¬è©¦å…§å®¹åˆ°ç« ç¯€è³‡æ–™åº«
 */

const { Pool } = require('pg');
require('dotenv').config({ path: '.env.local', override: true });

async function addLongTestContent() {
  console.log('ğŸ“ æ·»åŠ é•·æ¸¬è©¦å…§å®¹åˆ°ç« ç¯€...');
  
  const pool = new Pool({
    user: 'postgres',
    host: 'localhost',
    database: 'myainovel',
    port: 5432,
    password: '1234',
    ssl: false
  });

  try {
    const client = await pool.connect();
    console.log('âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸ\n');

    // é•·æ¸¬è©¦å…§å®¹
    const longContent = `
ç¬¬ä¸€ç« ï¼šé­”æ³•å­¸é™¢çš„ç§˜å¯†

è‰¾è‰äºç«™åœ¨å¤è€çš„é­”æ³•å­¸é™¢å¤§é–€å‰ï¼Œæ‰‹ä¸­ç·Šæ¡è‘—é‚£å°ç¥ç§˜çš„ä¿¡ä»¶ã€‚ä¿¡å°ä¸Šç‡™é‡‘çš„å­—é«”åœ¨å¤•é™½ä¸‹é–ƒé–ƒç™¼å…‰ï¼Œä¸Šé¢å¯«è‘—ï¼šã€Œè‡´è‰¾è‰äºÂ·æ˜Ÿæœˆï¼Œé­”æ³•å­¸é™¢èª æ‘¯é‚€è«‹æ‚¨åŠ å…¥æˆ‘å€‘çš„è¡Œåˆ—ã€‚ã€

å¥¹æ·±å¸ä¸€å£æ°£ï¼Œæ¨é–‹äº†é‚£æ‰‡æ²‰é‡çš„æœ¨é–€ã€‚é–€å¾Œæ˜¯ä¸€å€‹å……æ»¿é­”æ³•çš„ä¸–ç•Œâ€”â€”æ¼‚æµ®çš„æ›¸æœ¬åœ¨ç©ºä¸­ç·©ç·©ç§»å‹•ï¼Œå„ç¨®é¡è‰²çš„å…‰èŠ’åœ¨èµ°å»Šä¸­é–ƒçˆï¼Œé è™•å‚³ä¾†å­¸ç”Ÿå€‘ç·´ç¿’å’’èªçš„è²éŸ³ã€‚

ã€Œæ­¡è¿ä¾†åˆ°é­”æ³•å­¸é™¢ï¼Œè¦ªæ„›çš„ã€‚ã€ä¸€å€‹æº«å’Œçš„è²éŸ³å¾èº«å¾Œå‚³ä¾†ã€‚è‰¾è‰äºè½‰éèº«ï¼Œçœ‹åˆ°ä¸€ä½ç©¿è‘—æ·±è—è‰²é•·è¢çš„è€è€…æ­£å¾®ç¬‘è‘—çœ‹è‘—å¥¹ã€‚

ã€Œæˆ‘æ˜¯é™¢é•·æ¢…æ—ï¼Œå¾ˆé«˜èˆˆè¦‹åˆ°ä½ ã€‚ã€è€è€…ä¼¸å‡ºæ‰‹ï¼Œã€Œæˆ‘çŸ¥é“ä½ æœ‰å¾ˆå¤šç–‘å•ï¼Œä½†é¦–å…ˆï¼Œè®“æˆ‘å¸¶ä½ åƒè§€ä¸€ä¸‹é€™å€‹ç¥å¥‡çš„åœ°æ–¹ã€‚ã€

ä»–å€‘ç©¿éé•·é•·çš„èµ°å»Šï¼Œç¶“éäº†åœ–æ›¸é¤¨ã€å¯¦é©—å®¤ã€é‚„æœ‰å­¸ç”Ÿå®¿èˆã€‚æ¯å€‹åœ°æ–¹éƒ½å……æ»¿äº†é­”æ³•çš„æ°£æ¯ï¼Œè®“è‰¾è‰äºæ„Ÿåˆ°æ—¢èˆˆå¥®åˆç·Šå¼µã€‚

ã€Œé€™è£¡æ˜¯æˆ‘å€‘çš„é­”æ³•å¯¦é©—å®¤ï¼Œã€é™¢é•·æŒ‡è‘—ä¸€é–“å……æ»¿å„ç¨®é­”æ³•å™¨å…·çš„æˆ¿é–“èªªï¼Œã€Œå­¸ç”Ÿå€‘åœ¨é€™è£¡å­¸ç¿’å„ç¨®é­”æ³•æŠ€å·§ï¼Œå¾åŸºç¤çš„è®Šå½¢è¡“åˆ°é«˜ç´šçš„å¬å–šè¡“ã€‚ã€

è‰¾è‰äºçœ‹åˆ°å¹¾å€‹å­¸ç”Ÿæ­£åœ¨ç·´ç¿’æ¼‚æµ®è¡“ï¼Œä»–å€‘å°ˆæ³¨åœ°å¿µè‘—å’’èªï¼Œè®“ç¾½æ¯›åœ¨ç©ºä¸­å„ªé›…åœ°èˆå‹•ã€‚å¥¹ä¸ç¦æƒ³åƒè‡ªå·±ä¹Ÿèƒ½æŒæ¡é€™äº›ç¥å¥‡çš„æŠ€èƒ½ã€‚

ã€Œä½†æ˜¯ï¼Œã€é™¢é•·çš„èªæ°£çªç„¶è®Šå¾—åš´è‚…ï¼Œã€Œé­”æ³•å­¸é™¢ä¹Ÿæœ‰å®ƒçš„å±éšªã€‚æœ€è¿‘ï¼Œæˆ‘å€‘ç™¼ç¾äº†ä¸€äº›ä¸å°‹å¸¸çš„ç¾è±¡â€”â€”å¤è€çš„å°å°é–‹å§‹é¬†å‹•ï¼Œé»‘æš—çš„åŠ›é‡æ­£åœ¨è ¢è ¢æ¬²å‹•ã€‚ã€

è‰¾è‰äºæ„Ÿåˆ°ä¸€é™£å¯’æ„ï¼Œã€Œä»€éº¼æ„æ€ï¼Ÿã€

ã€Œæ„æ€æ˜¯ï¼Œã€é™¢é•·çœ‹è‘—å¥¹çš„çœ¼ç›ï¼Œã€Œä½ ä¾†åˆ°é€™è£¡ä¸æ˜¯å¶ç„¶çš„ã€‚ä½ çš„è¡€çµ±ä¸­è˜Šå«è‘—å¼·å¤§çš„é­”æ³•åŠ›é‡ï¼Œè€Œé€™å€‹ä¸–ç•Œéœ€è¦ä½ ä¾†å¹«åŠ©æˆ‘å€‘å°æŠ—å³å°‡åˆ°ä¾†çš„é»‘æš—ã€‚ã€

å°±åœ¨é€™æ™‚ï¼Œé è™•å‚³ä¾†ä¸€è²å·¨éŸ¿ï¼Œæ•´å€‹å­¸é™¢éƒ½éœ‡å‹•èµ·ä¾†ã€‚å­¸ç”Ÿå€‘é©šæ…Œå¤±æªåœ°å››è™•å¥”è·‘ï¼Œè€Œé™¢é•·çš„è¡¨æƒ…è®Šå¾—æ›´åŠ åš´è‚…ã€‚

ã€Œçœ‹ä¾†æ™‚é–“æ¯”æˆ‘å€‘æƒ³åƒçš„é‚„è¦ç·Šè¿«ï¼Œã€ä»–å¿«é€Ÿåœ°èªªï¼Œã€Œè‰¾è‰äºï¼Œä½ å¿…é ˆåšå‡ºé¸æ“‡ã€‚ä½ å¯ä»¥é¸æ“‡ç•™åœ¨é€™è£¡ï¼Œå­¸ç¿’é­”æ³•ï¼Œæº–å‚™é¢å°å³å°‡åˆ°ä¾†çš„æŒ‘æˆ°ï¼›æˆ–è€…ä½ å¯ä»¥é›¢é–‹ï¼Œå›åˆ°å¹³å‡¡çš„ç”Ÿæ´»ä¸­ã€‚ã€

è‰¾è‰äºçœ‹è‘—çª—å¤–ï¼Œçœ‹åˆ°å¤©ç©ºä¸­å‡ºç¾äº†ä¸ç¥¥çš„é»‘è‰²é›²æœµï¼Œé›·é›»åœ¨å…¶ä¸­é–ƒçˆã€‚å¥¹çŸ¥é“ï¼Œé€™å€‹é¸æ“‡å°‡æ”¹è®Šå¥¹çš„ä¸€ç”Ÿã€‚

ã€Œæˆ‘...ã€å¥¹çŒ¶è±«äº†ä¸€ä¸‹ï¼Œç„¶å¾Œå …å®šåœ°èªªï¼Œã€Œæˆ‘é¸æ“‡ç•™ä¸‹ã€‚æˆ‘è¦å­¸ç¿’é­”æ³•ï¼Œä¿è­·é€™å€‹ä¸–ç•Œã€‚ã€

é™¢é•·éœ²å‡ºäº†æ¬£æ…°çš„ç¬‘å®¹ï¼Œã€Œå¾ˆå¥½ï¼Œé‚£éº¼å¾æ˜å¤©é–‹å§‹ï¼Œä½ å°‡æ­£å¼æˆç‚ºé­”æ³•å­¸é™¢çš„ä¸€å“¡ã€‚ä½†é¦–å…ˆï¼Œæˆ‘å€‘éœ€è¦ç‚ºä½ æº–å‚™ä¸€äº›æ±è¥¿ã€‚ã€

ä»–å¾é•·è¢ä¸­å–å‡ºä¸€æ ¹ç²¾ç¾çš„é­”æ–ï¼Œæ–èº«æ˜¯æ·±è‰²çš„æœ¨æï¼Œé ‚ç«¯é‘²åµŒè‘—ä¸€é¡†é–ƒé–ƒç™¼å…‰çš„è—è‰²å¯¶çŸ³ã€‚

ã€Œé€™æ ¹é­”æ–æ›¾ç¶“å±¬æ–¼ä¸€ä½å‰å¤§çš„é­”æ³•å¸«ï¼Œã€é™¢é•·å°‡é­”æ–éçµ¦è‰¾è‰äºï¼Œã€Œç¾åœ¨å®ƒå±¬æ–¼ä½ äº†ã€‚è¨˜ä½ï¼Œé­”æ–åªæ˜¯å·¥å…·ï¼ŒçœŸæ­£çš„åŠ›é‡ä¾†è‡ªæ–¼ä½ çš„å…§å¿ƒã€‚ã€

è‰¾è‰äºæ¥éé­”æ–ï¼Œæ„Ÿåˆ°ä¸€è‚¡æº«æš–çš„åŠ›é‡å¾ä¸­å‚³ä¾†ã€‚å¥¹çŸ¥é“è‡ªå·±çš„äººç”Ÿå¾æ­¤å°‡å®Œå…¨ä¸åŒã€‚

ã€Œç¾åœ¨ï¼Œã€é™¢é•·èªªï¼Œã€Œè®“æˆ‘å€‘å»è¦‹è¦‹ä½ çš„åŒå­¸å€‘ã€‚ä»–å€‘éƒ½æ˜¯ä¾†è‡ªä¸–ç•Œå„åœ°çš„å¹´è¼•é­”æ³•å¸«ï¼Œæ¯å€‹äººéƒ½æœ‰è‡ªå·±ç¨ç‰¹çš„å¤©è³¦ã€‚ã€

ä»–å€‘èµ°å‘å­¸ç”Ÿå®¿èˆï¼Œè‰¾è‰äºçœ‹åˆ°è¨±å¤šåŒé½¡çš„å­¸ç”Ÿæ­£åœ¨äº¤æµï¼Œåˆ†äº«å½¼æ­¤çš„é­”æ³•ç¶“é©—ã€‚å¥¹æ„Ÿåˆ°æ—¢èˆˆå¥®åˆç·Šå¼µï¼Œä¸çŸ¥é“è‡ªå·±åœ¨é€™å€‹æ–°ä¸–ç•Œä¸­æœƒé‡åˆ°ä»€éº¼æ¨£çš„å†’éšªã€‚

ã€Œè¨˜ä½ï¼Œã€é™¢é•·åœ¨é›¢é–‹å‰å°å¥¹èªªï¼Œã€Œé­”æ³•å­¸é™¢ä¸åƒ…åƒ…æ˜¯å­¸ç¿’é­”æ³•çš„åœ°æ–¹ï¼Œå®ƒä¹Ÿæ˜¯ä½ çš„å®¶ã€‚ç„¡è«–é‡åˆ°ä»€éº¼å›°é›£ï¼Œéƒ½è¦ç›¸ä¿¡è‡ªå·±çš„åŠ›é‡ï¼Œç›¸ä¿¡ä½ çš„æœ‹å‹å€‘ã€‚ã€

è‰¾è‰äºé»é»é ­ï¼Œçœ‹è‘—é™¢é•·é›¢å»çš„èƒŒå½±ã€‚å¥¹çŸ¥é“ï¼Œå¾ä»Šå¤©é–‹å§‹ï¼Œå¥¹å°‡è¸ä¸Šä¸€æ®µå……æ»¿é­”æ³•ã€å‹èª¼å’Œå†’éšªçš„æ—…ç¨‹ã€‚

è€Œé€™ï¼Œåªæ˜¯é–‹å§‹ã€‚

é è™•çš„é˜è²éŸ¿èµ·ï¼Œå®£å‘Šè‘—æ™šé¤æ™‚é–“çš„åˆ°ä¾†ã€‚è‰¾è‰äºæ·±å¸ä¸€å£æ°£ï¼Œèµ°å‘å­¸ç”Ÿå€‘èšé›†çš„åœ°æ–¹ï¼Œæº–å‚™é–‹å§‹å¥¹åœ¨é­”æ³•å­¸é™¢çš„æ–°ç”Ÿæ´»ã€‚

å¥¹ä¸çŸ¥é“çš„æ˜¯ï¼Œåœ¨å­¸é™¢çš„æ·±è™•ï¼Œä¸€å€‹å¤è€çš„é è¨€æ­£åœ¨æ‡‰é©—ï¼Œè€Œå¥¹çš„åˆ°ä¾†ï¼Œæ­£æ˜¯é€™å€‹é è¨€ä¸­æœ€é‡è¦çš„éƒ¨åˆ†ã€‚

é»‘æš—æ­£åœ¨é€¼è¿‘ï¼Œä½†å…‰æ˜ä¹Ÿå°‡éš¨ä¹‹è€Œä¾†ã€‚è‰¾è‰äºÂ·æ˜Ÿæœˆï¼Œé€™å€‹åå­—å°‡åœ¨é­”æ³•ä¸–ç•Œçš„æ­·å²ä¸­ç•™ä¸‹æ·±åˆ»çš„å°è¨˜ã€‚

è€Œé€™ä¸€åˆ‡ï¼Œéƒ½å°‡å¾æ˜å¤©é–‹å§‹ã€‚

ç•¶å¤œå¹•é™è‡¨ï¼Œè‰¾è‰äºèººåœ¨å®¿èˆçš„åºŠä¸Šï¼Œçœ‹è‘—çª—å¤–çš„æ˜Ÿç©ºï¼Œå¿ƒä¸­å……æ»¿äº†å°æœªä¾†çš„æœŸå¾…å’Œå°æœªçŸ¥çš„ææ‡¼ã€‚å¥¹çŸ¥é“ï¼Œæ˜å¤©å°‡æ˜¯å¥¹åœ¨é­”æ³•å­¸é™¢çš„ç¬¬ä¸€å¤©ï¼Œä¹Ÿæ˜¯å¥¹äººç”Ÿæ–°ç¯‡ç« çš„é–‹å§‹ã€‚

ã€Œé¡˜é­”æ³•èˆ‡æˆ‘åŒåœ¨ï¼Œã€å¥¹è¼•è²èªªé“ï¼Œç„¶å¾Œé–‰ä¸Šçœ¼ç›ï¼Œæº–å‚™è¿æ¥æ˜å¤©çš„æŒ‘æˆ°ã€‚

åœ¨å¤¢ä¸­ï¼Œå¥¹çœ‹åˆ°äº†ç„¡æ•¸çš„é­”æ³•å…‰èŠ’ï¼Œè½åˆ°äº†å¤è€çš„å’’èªè²ï¼Œæ„Ÿå—åˆ°äº†ä¾†è‡ªå…§å¿ƒæ·±è™•çš„é­”æ³•åŠ›é‡ã€‚å¥¹çŸ¥é“ï¼Œé€™ä¸æ˜¯å¤¢ï¼Œè€Œæ˜¯å¥¹çœŸæ­£çš„å‘½é‹ã€‚

æ˜å¤©ï¼Œå¥¹å°‡æ­£å¼æˆç‚ºä¸€åé­”æ³•å¸«ã€‚

æ˜å¤©ï¼Œå¥¹å°‡é–‹å§‹å­¸ç¿’å¦‚ä½•ä¿è­·é€™å€‹ä¸–ç•Œã€‚

æ˜å¤©ï¼Œå¥¹å°‡ç™¼ç¾è‡ªå·±çœŸæ­£çš„åŠ›é‡ã€‚

è€Œé€™ä¸€åˆ‡ï¼Œéƒ½å°‡å¾é­”æ³•å­¸é™¢é–‹å§‹ã€‚

è‰¾è‰äºÂ·æ˜Ÿæœˆçš„é­”æ³•ä¹‹æ—…ï¼Œæ­£å¼é–‹å§‹äº†ã€‚
    `.trim();

    // æ›´æ–°ç¾æœ‰ç« ç¯€çš„å…§å®¹
    const updateResult = await client.query(`
      UPDATE chapters 
      SET full_text = $1, summary = $2
      WHERE story_id IN (
        SELECT story_id FROM stories 
        WHERE status = 'æŠ•ç¥¨ä¸­' OR status = 'æ’°å¯«ä¸­'
        LIMIT 3
      )
      RETURNING chapter_id, title
    `, [
      longContent,
      'è‰¾è‰äºé€²å…¥é­”æ³•å­¸é™¢ï¼Œç™¼ç¾è‡ªå·±æ“æœ‰å¼·å¤§çš„é­”æ³•åŠ›é‡ï¼Œå¿…é ˆé¸æ“‡æ˜¯å¦ç•™ä¸‹å­¸ç¿’é­”æ³•å°æŠ—å³å°‡åˆ°ä¾†çš„é»‘æš—ã€‚'
    ]);

    console.log('âœ… å·²æ›´æ–°ç« ç¯€å…§å®¹:');
    updateResult.rows.forEach(row => {
      console.log(`  - ${row.title} (ID: ${row.chapter_id})`);
    });

    // å¦‚æœæ²’æœ‰ç¾æœ‰ç« ç¯€ï¼Œå‰µå»ºä¸€å€‹æ–°çš„æ¸¬è©¦ç« ç¯€
    if (updateResult.rows.length === 0) {
      console.log('\nğŸ“ æ²’æœ‰ç¾æœ‰ç« ç¯€ï¼Œå‰µå»ºæ–°çš„æ¸¬è©¦ç« ç¯€...');
      
      // å…ˆå‰µå»ºæ¸¬è©¦æ•…äº‹
      const storyResult = await client.query(`
        INSERT INTO stories (story_id, story_serial, title, status, origin_voting_start_date)
        VALUES ($1, $2, $3, $4, NOW())
        RETURNING story_id
      `, [
        '550e8400-e29b-41d4-a716-446655440999',
        'T999',
        'é­”æ³•å­¸é™¢çš„ç§˜å¯†',
        'æŠ•ç¥¨ä¸­'
      ]);

      const storyId = storyResult.rows[0].story_id;
      console.log('âœ… æ¸¬è©¦æ•…äº‹å‰µå»ºæˆåŠŸ:', storyId);

      // å‰µå»ºæ¸¬è©¦ç« ç¯€
      const chapterResult = await client.query(`
        INSERT INTO chapters (
          story_id, chapter_number, title, full_text, summary,
          voting_status, voting_deadline, voting_options, tags
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        RETURNING chapter_id
      `, [
        storyId,
        '001',
        'ç¬¬ä¸€ç« ï¼šé­”æ³•å­¸é™¢çš„ç§˜å¯†',
        longContent,
        'è‰¾è‰äºé€²å…¥é­”æ³•å­¸é™¢ï¼Œç™¼ç¾è‡ªå·±æ“æœ‰å¼·å¤§çš„é­”æ³•åŠ›é‡ï¼Œå¿…é ˆé¸æ“‡æ˜¯å¦ç•™ä¸‹å­¸ç¿’é­”æ³•å°æŠ—å³å°‡åˆ°ä¾†çš„é»‘æš—ã€‚',
        'é€²è¡Œä¸­',
        new Date(Date.now() + 24 * 60 * 60 * 1000), // 24å°æ™‚å¾Œæˆªæ­¢
        JSON.stringify({
          options: [
            { id: 'A', content: 'é¸æ“‡ç•™åœ¨é­”æ³•å­¸é™¢å­¸ç¿’', description: 'å‹‡æ•¢åœ°æ¥å—æŒ‘æˆ°ï¼Œå­¸ç¿’é­”æ³•å°æŠ—é»‘æš—' },
            { id: 'B', content: 'é¸æ“‡é›¢é–‹å›åˆ°å¹³å‡¡ç”Ÿæ´»', description: 'é¸æ“‡å®‰å…¨çš„ç”Ÿæ´»ï¼Œé é›¢å±éšª' },
            { id: 'C', content: 'é¸æ“‡å…ˆè§€å¯Ÿå†åšæ±ºå®š', description: 'è¬¹æ…åœ°è§€å¯Ÿæƒ…æ³ï¼Œä¸æ€¥æ–¼åšæ±ºå®š' }
          ],
          total_votes: 0
        }),
        JSON.stringify(['é­”æ³•', 'å­¸é™¢', 'å†’éšª', 'å¥‡å¹»', 'æˆé•·'])
      ]);

      const chapterId = chapterResult.rows[0].chapter_id;
      console.log('âœ… æ¸¬è©¦ç« ç¯€å‰µå»ºæˆåŠŸ:', chapterId);
    }

    // é©—è­‰æ›´æ–°çµæœ
    const verifyResult = await client.query(`
      SELECT c.chapter_id, c.title, c.full_text, s.title as story_title
      FROM chapters c
      JOIN stories s ON c.story_id = s.story_id
      WHERE LENGTH(c.full_text) > 1000
      ORDER BY c.created_at DESC
      LIMIT 3
    `);

    console.log('\nğŸ“Š é©—è­‰çµæœ:');
    verifyResult.rows.forEach(row => {
      console.log(`  - ${row.story_title}: ${row.title}`);
      console.log(`    å…§å®¹é•·åº¦: ${row.full_text.length} å­—å…ƒ`);
    });

    client.release();
    console.log('\nâœ… é•·æ¸¬è©¦å…§å®¹æ·»åŠ å®Œæˆï¼');
    
  } catch (error) {
    console.error('âŒ éŒ¯èª¤:', error.message);
  } finally {
    await pool.end();
  }
}

// åŸ·è¡Œå‡½æ•¸
addLongTestContent().catch(console.error);
